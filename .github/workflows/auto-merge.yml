name: Auto Merge

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull request number to auto-merge"
        required: true
        type: string

jobs:
  auto-merge:
    name: Auto Merge PR
    runs-on: ubuntu-latest
    if: github.event.inputs.pr_number != ''
    permissions:
      contents: write
      pull-requests: write
      checks: read
      statuses: read

    steps:
      - name: Debug inputs
        run: |
          echo "=== Auto-Merge Inputs Debug ==="
          echo "PR Number: ${{ github.event.inputs.pr_number }}"
          echo "Event name: ${{ github.event_name }}"
          echo "================================="

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if PR is ready for merge
        id: check-status
        run: |
          PR_NUMBER="${{ github.event.inputs.pr_number }}"
          echo "Checking if PR $PR_NUMBER is ready for merge..."

          # Get the PR details
          PR_INFO=$(gh pr view $PR_NUMBER --json mergeable,mergeStateStatus,reviewDecision,labels)
          echo "PR info: $PR_INFO"

          # Check if PR is mergeable
          MERGEABLE=$(echo "$PR_INFO" | jq -r '.mergeable')
          MERGE_STATE=$(echo "$PR_INFO" | jq -r '.mergeStateStatus')
          REVIEW_DECISION=$(echo "$PR_INFO" | jq -r '.reviewDecision')

          echo "Mergeable: $MERGEABLE"
          echo "Merge state: $MERGE_STATE"
          echo "Review decision: $REVIEW_DECISION"

          # Check if PR has required labels (if any)
          LABELS=$(echo "$PR_INFO" | jq -r '.labels[].name' | tr '\n' ' ')
          echo "Labels: $LABELS"

          # Check if PR is ready for merge
          if [ "$MERGEABLE" == "MERGEABLE" ] && [ "$MERGE_STATE" == "CLEAN" ]; then
            echo "ready=true" >> $GITHUB_OUTPUT
            echo "PR is ready for merge"
          else
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "PR is not ready for merge"
            echo "Mergeable: $MERGEABLE, Merge state: $MERGE_STATE"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto merge PR
        if: steps.check-status.outputs.ready == 'true'
        run: |
          PR_NUMBER="${{ github.event.inputs.pr_number }}"

          echo "Attempting to merge PR $PR_NUMBER..."

          # Try to merge the PR with squash strategy
          gh pr merge $PR_NUMBER --auto --squash

          if [ $? -eq 0 ]; then
            echo "‚úÖ PR $PR_NUMBER merged successfully"
          else
            echo "‚ùå Failed to merge PR $PR_NUMBER"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR
        if: steps.check-status.outputs.ready == 'true'
        run: |
          PR_NUMBER="${{ github.event.inputs.pr_number }}"

          gh pr comment $PR_NUMBER --body "ü§ñ **Auto-merge completed!** This PR has been automatically merged after all required checks passed, including E2E Tests."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
