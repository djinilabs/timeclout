name: Auto Merge

on:
  workflow_run:
    workflows: ["E2E Tests"]
    types: [completed]

jobs:
  auto-merge:
    name: Auto Merge PR
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'workflow_dispatch'
    permissions:
      contents: write
      pull-requests: write
      checks: read
      statuses: read
      actions: read

    steps:
      - name: Debug workflow run event
        run: |
          echo "=== Workflow Run Event Debug ==="
          echo "Event name: ${{ github.event_name }}"
          echo "Workflow run ID: ${{ github.event.workflow_run.id }}"
          echo "Workflow run name: ${{ github.event.workflow_run.name }}"
          echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Workflow run event: ${{ github.event.workflow_run.event }}"
          echo "Workflow run head SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "Workflow run head branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Workflow run repository: ${{ github.event.workflow_run.repository.full_name }}"
          echo "Workflow run head repository: ${{ github.event.workflow_run.head_repository.full_name }}"
          echo "Workflow run actor: ${{ github.event.workflow_run.actor.login }}"
          echo "Workflow run created at: ${{ github.event.workflow_run.created_at }}"
          echo "Workflow run updated at: ${{ github.event.workflow_run.updated_at }}"
          echo "================================="

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR details
        id: pr
        run: |
          # Get the PR number from the workflow run event
          WORKFLOW_RUN_ID="${{ github.event.workflow_run.id }}"

          # Get the PR details from the workflow run
          WORKFLOW_RUN_INFO=$(gh api repos/${{ github.repository }}/actions/runs/$WORKFLOW_RUN_ID)
          echo "Workflow run info: $WORKFLOW_RUN_INFO"

          # Try to get PR number from the workflow run inputs
          PR_NUMBER=$(echo "$WORKFLOW_RUN_INFO" | jq -r '.inputs.pull_request_number // empty')

          if [ -z "$PR_NUMBER" ]; then
            echo "No PR number found in workflow inputs, trying to find PR by head SHA..."
            HEAD_SHA="${{ github.event.workflow_run.head_sha }}"
            
            # Find PR by head SHA
            PR_INFO=$(gh api repos/${{ github.repository }}/commits/$HEAD_SHA/pulls)
            PR_NUMBER=$(echo "$PR_INFO" | jq -r '.[0].number // empty')
          fi

          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found for this workflow run"
            exit 1
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "PR number: $PR_NUMBER"

      - name: Check if PR is ready for merge
        id: check-status
        run: |
          PR_NUMBER="${{ steps.pr.outputs.pr_number }}"

          # Get the PR details
          PR_INFO=$(gh pr view $PR_NUMBER --json mergeable,mergeStateStatus,reviewDecision,labels)
          echo "PR info: $PR_INFO"

          # Check if PR is mergeable
          MERGEABLE=$(echo "$PR_INFO" | jq -r '.mergeable')
          MERGE_STATE=$(echo "$PR_INFO" | jq -r '.mergeStateStatus')
          REVIEW_DECISION=$(echo "$PR_INFO" | jq -r '.reviewDecision')

          echo "Mergeable: $MERGEABLE"
          echo "Merge state: $MERGE_STATE"
          echo "Review decision: $REVIEW_DECISION"

          # Check if PR has required labels (if any)
          LABELS=$(echo "$PR_INFO" | jq -r '.labels[].name' | tr '\n' ' ')
          echo "Labels: $LABELS"

          # Check if PR is ready for merge
          if [ "$MERGEABLE" == "MERGEABLE" ] && [ "$MERGE_STATE" == "CLEAN" ]; then
            echo "ready=true" >> $GITHUB_OUTPUT
            echo "PR is ready for merge"
          else
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "PR is not ready for merge"
            echo "Mergeable: $MERGEABLE, Merge state: $MERGE_STATE"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for other required checks to complete
        if: steps.check-status.outputs.ready == 'true'
        run: |
          PR_NUMBER="${{ steps.pr.outputs.pr_number }}"
          echo "Waiting for other required checks to complete..."

          # Define the other required checks (excluding E2E Tests since we already know it passed)
          REQUIRED_CHECKS=("Test" "Deploy PR")

          echo "Required checks: ${REQUIRED_CHECKS[*]}"

          # Wait for each required check to complete
          for check in "${REQUIRED_CHECKS[@]}"; do
            echo "Waiting for check: $check"
            
            # Wait for the check to complete
            while true; do
              # Get the latest status for this check
              STATUS=$(gh api repos/${{ github.repository }}/commits/${{ github.sha }}/statuses | jq -r ".[] | select(.context == \"$check\") | .state" | head -1)
              
              if [ "$STATUS" == "success" ]; then
                echo "‚úÖ Check $check passed"
                break
              elif [ "$STATUS" == "failure" ] || [ "$STATUS" == "error" ]; then
                echo "‚ùå Check $check failed"
                exit 1
              else
                echo "‚è≥ Check $check still running (status: $STATUS)"
                sleep 30
              fi
            done
          done

          echo "All required checks completed successfully"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto merge PR
        if: steps.check-status.outputs.ready == 'true'
        run: |
          PR_NUMBER="${{ steps.pr.outputs.pr_number }}"

          echo "Attempting to merge PR $PR_NUMBER..."

          # Try to merge the PR with squash strategy
          gh pr merge $PR_NUMBER --auto --squash

          if [ $? -eq 0 ]; then
            echo "‚úÖ PR $PR_NUMBER merged successfully"
          else
            echo "‚ùå Failed to merge PR $PR_NUMBER"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR
        if: steps.check-status.outputs.ready == 'true'
        run: |
          PR_NUMBER="${{ steps.pr.outputs.pr_number }}"

          gh pr comment $PR_NUMBER --body "ü§ñ **Auto-merge completed!** This PR has been automatically merged after all required checks passed, including E2E Tests."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
